<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gold App | Stable Version</title>
    
    <style>
        :root {
            /* THEME VARIABLES */
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --glass-bg: rgba(20, 20, 20, 0.85); /* Increased opacity for performance */
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            /* Removed heavy blur from root to prevent scrolling lag */
            
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
            --color-orange: #ff9f43; 
            --color-blue: #0abde3; 
            --color-golden: #ffd700;
            --accent-active: var(--color-golden);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; touch-action: manipulation; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-gradient); 
            color: var(--text-main); 
            margin: 0; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; 
            background-attachment: fixed;
        }

        .app-container { width: 100%; max-width: 450px; padding: 15px; padding-bottom: 380px; position: relative; }
        
        /* HEADER */
        .header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; 
            background: var(--glass-bg); 
            padding: 12px 15px; border-radius: 20px; border: var(--glass-border); 
            position: relative; z-index: 100;
        }
        .logo-area h3 { margin: 0; font-size: 18px; color: var(--accent-active); text-transform: uppercase; font-weight: 800; letter-spacing: 1px; text-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        
        /* MENU */
        #menuPopup {
            display: none; position: absolute; top: 70px; left: 15px; width: 220px;
            background: #1a1a25; /* Solid color for menu stability */
            border: 1px solid rgba(255,255,255,0.15); border-radius: 15px; padding: 15px; z-index: 3000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); flex-direction: column; gap: 12px;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.05); color: #fff; padding: 12px; border-radius: 10px; border: none;
            font-size: 15px; font-weight: 600; text-align: left; display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .menu-btn:active { background: var(--accent-active); color: #000; }

        /* CARD - Optimized for PDF */
        .card { 
            background: var(--glass-bg); 
            padding: 20px; border-radius: 25px; border: var(--glass-border); margin-bottom: 15px; 
        }

        /* INPUTS */
        .main-input { 
            width: 100%; padding: 15px; margin-bottom: 15px; background: rgba(0, 0, 0, 0.3); border: var(--glass-border); 
            border-radius: 15px; font-size: 32px; color: var(--accent-active); text-align: center; font-weight: bold; transition: 0.2s;
        }
        .main-input.active-field { border-color: var(--accent-active); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }

        .tab-box { display: flex; gap: 8px; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 30px; border: var(--glass-border); }
        .t-btn { background: transparent; color: #aaa; border: none; padding: 10px; border-radius: 25px; font-size: 12px; font-weight: bold; flex: 1; cursor: pointer; transition: 0.2s; }
        .t-btn.active-22 { background: var(--color-orange); color: #000; box-shadow: 0 0 15px var(--color-orange); }
        .t-btn.active-21 { background: var(--color-blue); color: #fff; box-shadow: 0 0 15px var(--color-blue); }
        .t-btn.active-both { background: var(--color-golden); color: #000; box-shadow: 0 0 15px var(--color-golden); }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .small-input { 
            width: 100%; padding: 14px; background: rgba(0, 0, 0, 0.3); border: var(--glass-border); border-radius: 12px; 
            color: #fff; text-align: center; font-weight: bold; transition: 0.2s;
        }
        .small-input.active-field { border-color: var(--accent-active); box-shadow: 0 0 10px var(--accent-active); }

        .weight-input { 
            width: 100%; padding: 18px; background: rgba(0, 0, 0, 0.5); border: var(--glass-border); border-radius: 15px; 
            color: #fff; text-align: center; font-size: 26px; font-weight: bold; 
        }
        .weight-input.active-field { border-color: var(--accent-active); box-shadow: 0 0 15px rgba(255,255,255,0.15); }

        .sec-22 { border-left: 4px solid var(--color-orange); padding-left: 15px; margin-bottom: 20px; }
        .sec-21 { border-left: 4px solid var(--color-blue); padding-left: 15px; margin-bottom: 20px; }
        .hidden { display: none; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 15px; }
        
        .btn-action { 
            width: 100%; padding: 16px; background: linear-gradient(135deg, #1db954, #1aa34a); 
            color: #fff; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; margin-top: 15px; 
            cursor: pointer; box-shadow: 0 5px 15px rgba(29, 185, 84, 0.5);
        }

        /* KEYPAD - Optimized for No Lag */
        #customKeypad {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: #12121a; /* Solid background prevents glass-lag on animation */
            border-top: 1px solid rgba(255,255,255,0.2); border-radius: 35px 35px 0 0; padding: 20px 15px; 
            transition: bottom 0.2s ease-out; z-index: 5000; 
            box-shadow: 0 -10px 40px rgba(0, 150, 255, 0.15);
        }
        #customKeypad.show { bottom: 0; }
        .keypad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 5px; }
        
        .k-btn {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff; font-size: 28px; font-weight: 700; padding: 15px 0; border-radius: 18px;
            cursor: pointer; user-select: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5), 0 0 20px rgba(0, 190, 255, 0.25);
        }
        .k-btn:active { transform: scale(0.95); background: var(--accent-active); color: #000; box-shadow: 0 0 30px var(--accent-active); }
        
        .k-close { 
            grid-column: span 3; background: rgba(255, 80, 80, 0.15); border: 1px solid rgba(255, 80, 80, 0.4);
            color: #ff8080; font-size: 16px; padding: 12px; margin-bottom: 10px;
        }

        #calculatorPage, #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0c29; z-index: 1000; padding: 20px; overflow-y: auto; }
        
        .conv-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; border: var(--glass-border); }
        .conv-inp { width: 100%; background: transparent; border: none; color: #fff; font-size: 22px; font-weight: bold; text-align: center; }
        .conv-lbl { font-size: 10px; color: var(--text-sub); margin-top: 5px; text-transform: uppercase; display: block; letter-spacing: 1px; }
    </style>
</head>
<body onload="init()">

<div class="app-container">
    <div class="header">
        <button onclick="toggleMenu()" style="background:var(--color-orange); border:none; width:40px; height:40px; border-radius:10px; color:#000; font-size:24px; font-weight:bold; cursor:pointer; box-shadow: 0 0 15px var(--color-orange);">+</button>
        <h3 id="appTitle">GOLD APP</h3>
        <div style="width:40px;"></div>
    </div>

    <div id="menuPopup">
        <button class="menu-btn" onclick="openP('calculatorPage'); toggleMenu()">
            <span style="font-size:20px;">üßÆ</span> Price Calculator
        </button>
        <div style="height:1px; background:rgba(255,255,255,0.1); margin:5px 0;"></div>
        <button class="menu-btn" onclick="openP('adminPanel'); toggleMenu()">
            <span style="font-size:20px;">‚öôÔ∏è</span> Settings
        </button>
    </div>

    <div class="card" id="main-content" style="text-align:center;">
        <h4 style="color:var(--color-orange); margin-bottom:15px; letter-spacing:2px;">WEIGHT CONVERTER</h4>
        <input type="text" inputmode="none" readonly id="cv_g" class="main-input num-field" placeholder="Grams" onclick="focusField(this)">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin:20px 0;">
            <div class="conv-box"><input type="text" inputmode="none" readonly id="res_v" class="conv-inp num-field" placeholder="0" onclick="focusField(this)"><span class="conv-lbl">Vori</span></div>
            <div class="conv-box"><input type="text" inputmode="none" readonly id="res_a" class="conv-inp num-field" placeholder="0" onclick="focusField(this)"><span class="conv-lbl">Ana</span></div>
            <div class="conv-box"><input type="text" inputmode="none" readonly id="res_r" class="conv-inp num-field" placeholder="0" onclick="focusField(this)"><span class="conv-lbl">Ratti</span></div>
        </div>
        <button class="btn-action" onclick="genPDF('main-content', 'Weight_Report.pdf')">DOWNLOAD REPORT</button>
    </div>
</div>

<div id="calculatorPage">
    <div class="header">
        <button onclick="closeP('calculatorPage')" style="background:var(--color-orange); color:#000; width:40px; height:40px; border-radius:12px; font-weight:bold; border:none; box-shadow: 0 0 20px var(--color-orange);">‚úï</button>
        <h3 style="color:var(--accent-active); margin:0;">CALCULATOR</h3>
        <div></div>
    </div>
    
    <div class="card" id="calc-content">
        <label style="font-size:11px; color:#bbb; text-transform:uppercase; letter-spacing:1px;">Screen Rate (Input Your Rate)</label>
        <input type="text" inputmode="none" readonly id="screenRate" class="main-input num-field" placeholder="0.00" onclick="focusField(this)">

        <div class="tab-box">
            <button class="t-btn" id="b22" onclick="setTab('22')">22K Only</button>
            <button class="t-btn" id="b21" onclick="setTab('21')">21K Only</button>
            <button class="t-btn active-both" id="bBoth" onclick="setTab('both')">Both</button>
        </div>

        <div id="sec22" class="sec-22">
            <div class="row"><span style="color:var(--color-orange); font-weight:bold;">22 Karat (92.6%)</span></div>
            <div class="grid-2">
                <input type="text" inputmode="none" readonly id="mc22" class="small-input num-field" placeholder="MC" onclick="focusField(this)">
                <input type="text" inputmode="none" readonly id="dh22" class="small-input num-field" placeholder="Dh" onclick="focusField(this)">
                <input type="text" inputmode="none" readonly id="cr22" class="small-input num-field" placeholder="CR" onclick="focusField(this)">
                <input type="text" inputmode="none" readonly id="mg22" class="small-input num-field" placeholder="MG" onclick="focusField(this)">
            </div>
            <input type="text" inputmode="none" readonly id="w22" class="weight-input num-field" placeholder="Weight (gm)" onclick="focusField(this)">
            <div class="row"><span>Rate Per Bhori</span> <span id="r22" style="font-weight:bold; color:#fff;">0.00</span></div>
            <div class="row"><span style="color:var(--color-orange); font-weight:900;">Total</span> <span id="t22" style="font-size:28px; font-weight:900; color:var(--color-orange); text-shadow:0 0 20px rgba(255,159,67,0.6);">0.00</span></div>
        </div>

        <div id="sec21" class="sec-21 hidden">
            <div class="row"><span style="color:var(--color-blue); font-weight:bold;">21 Karat (88.5%)</span></div>
            <div class="grid-2">
                <input type="text" inputmode="none" readonly id="mc21" class="small-input num-field" placeholder="MC" onclick="focusField(this)">
                <input type="text" inputmode="none" readonly id="dh21" class="small-input num-field" placeholder="Dh" onclick="focusField(this)">
                <input type="text" inputmode="none" readonly id="cr21" class="small-input num-field" placeholder="CR" onclick="focusField(this)">
                <input type="text" inputmode="none" readonly id="mg21" class="small-input num-field" placeholder="MG" onclick="focusField(this)">
            </div>
            <input type="text" inputmode="none" readonly id="w21" class="weight-input num-field" placeholder="Weight (gm)" onclick="focusField(this)">
            <div class="row"><span>Rate Per Bhori</span> <span id="r21" style="font-weight:bold; color:#fff;">0.00</span></div>
            <div class="row"><span style="color:var(--color-blue); font-weight:900;">Total</span> <span id="t21" style="font-size:28px; font-weight:900; color:var(--color-blue); text-shadow:0 0 20px rgba(10,189,227,0.6);">0.00</span></div>
        </div>

        <div style="background:rgba(0,0,0,0.4); padding:15px; border-radius:15px; text-align:center; border:var(--glass-border);">
            <div id="grandTotal" style="font-size:36px; font-weight:900; color:#fff;">0.00</div>
        </div>

        <div style="margin-top:20px;">
            <input id="cName" style="width:100%; padding:12px; margin-bottom:10px; background:rgba(0,0,0,0.3); border:var(--glass-border); border-radius:8px; color:#fff;" placeholder="Customer Name">
            <input id="authName" style="width:100%; padding:12px; background:rgba(0,0,0,0.3); border:var(--glass-border); border-radius:8px; color:#fff;" placeholder="Authorized By">
        </div>
        <button class="btn-action" onclick="genPDF('calc-content', 'Invoice.pdf')">DOWNLOAD INVOICE</button>
    </div>
</div>

<div id="customKeypad">
    <button class="k-btn k-close" onclick="closeKeypad()">Done ‚ñº</button>
    <div class="keypad-grid">
        <button class="k-btn" onclick="press('1')">1</button>
        <button class="k-btn" onclick="press('2')">2</button>
        <button class="k-btn" onclick="press('3')">3</button>
        <button class="k-btn" onclick="press('4')">4</button>
        <button class="k-btn" onclick="press('5')">5</button>
        <button class="k-btn" onclick="press('6')">6</button>
        <button class="k-btn" onclick="press('7')">7</button>
        <button class="k-btn" onclick="press('8')">8</button>
        <button class="k-btn" onclick="press('9')">9</button>
        <button class="k-btn" onclick="press('.')">.</button>
        <button class="k-btn" onclick="press('0')">0</button>
        <button class="k-btn" id="btn-back" style="color:#ff6b6b;">‚å´</button>
    </div>
</div>

<div id="adminPanel">
    <div class="admin-header">
        <h2 style="color:var(--color-golden); margin:0;">Admin Settings</h2>
        <button onclick="closeP('adminPanel')" style="background:none; border:none; color:red; font-size:30px;">‚úï</button>
    </div>
    <div class="card">
        <label class="lbl">App Title</label>
        <input id="cfg_title" class="small-input" style="width:100%; margin-bottom:15px;" oninput="document.getElementById('appTitle').innerText=this.value">
    </div>
    <button class="btn-action">SAVE SETTINGS</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
<script>
    let activeInput = null;
    let backTimer, backDelay;

    function init() { setTab('both'); setupBackspace(); }

    function toggleMenu() {
        const menu = document.getElementById('menuPopup');
        menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
    }

    function focusField(el) {
        if(activeInput) activeInput.classList.remove('active-field');
        activeInput = el;
        activeInput.classList.add('active-field');
        document.getElementById('customKeypad').classList.add('show');
        document.querySelector('.app-container').style.paddingBottom = "400px";
        document.getElementById('menuPopup').style.display = 'none';
    }

    function closeKeypad() {
        document.getElementById('customKeypad').classList.remove('show');
        if(activeInput) activeInput.classList.remove('active-field');
        document.querySelector('.app-container').style.paddingBottom = "15px";
    }

    function press(key) {
        if(!activeInput) return;
        if(key === 'back') activeInput.value = activeInput.value.slice(0, -1);
        else {
            if(key === '.' && activeInput.value.includes('.')) return;
            activeInput.value += key;
        }
        if(activeInput.id.startsWith('res_') || activeInput.id === 'cv_g') {
            if(activeInput.id === 'cv_g') gToV(); else vToG();
        } else calc();
    }

    // FIXED BACKSPACE LOOP (NO FREEZE)
    function setupBackspace() {
        const btn = document.getElementById('btn-back');
        const start = (e) => {
            // No e.preventDefault to allow scrolling
            press('back');
            backDelay = setTimeout(() => {
                backTimer = setInterval(() => { press('back'); }, 120); 
            }, 500);
        };
        const stop = () => { clearTimeout(backDelay); clearInterval(backTimer); };
        
        btn.addEventListener('mousedown', start);
        btn.addEventListener('touchstart', start, {passive: true});
        btn.addEventListener('mouseup', stop);
        btn.addEventListener('touchend', stop);
        btn.addEventListener('touchcancel', stop); // Fix for drag-off freeze
        btn.addEventListener('mouseleave', stop);
    }

    function setTab(t) {
        document.getElementById('b22').className = 't-btn';
        document.getElementById('b21').className = 't-btn';
        document.getElementById('bBoth').className = 't-btn';
        document.getElementById('sec22').classList.add('hidden');
        document.getElementById('sec21').classList.add('hidden');
        const root = document.documentElement;

        if(t === '22') {
            document.getElementById('b22').classList.add('active-22');
            document.getElementById('sec22').classList.remove('hidden');
            root.style.setProperty('--accent-active', 'var(--color-orange)');
        } else if(t === '21') {
            document.getElementById('b21').classList.add('active-21');
            document.getElementById('sec21').classList.remove('hidden');
            root.style.setProperty('--accent-active', 'var(--color-blue)');
        } else {
            document.getElementById('bBoth').classList.add('active-both');
            document.getElementById('sec22').classList.remove('hidden');
            document.getElementById('sec21').classList.remove('hidden');
            root.style.setProperty('--accent-active', 'var(--color-golden)');
        }
        calc();
    }

    function calc() {
        let baseRate = parseFloat(document.getElementById('screenRate').value) || 0;
        
        let purity22 = 0.926;
        let mc22 = parseFloat(document.getElementById('mc22').value) || 0;
        let dh22 = parseFloat(document.getElementById('dh22').value) || 0;
        let cr22 = parseFloat(document.getElementById('cr22').value) || 0;
        let mg22 = parseFloat(document.getElementById('mg22').value) || 0;
        
        let rate_per_bhori_22 = (((baseRate * 3.674 / 31.1035 * purity22) + mc22) * 11.664 * dh22) + cr22 + mg22;
        let w22_gm = parseFloat(document.getElementById('w22').value) || 0;
        let total22 = rate_per_bhori_22 * (w22_gm / 11.664);
        
        document.getElementById('r22').innerText = rate_per_bhori_22.toLocaleString(undefined, {maximumFractionDigits: 2});
        document.getElementById('t22').innerText = total2
