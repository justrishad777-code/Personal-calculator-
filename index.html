<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gold App Premium</title>
    
    <link rel="manifest" href="./manifest.json">
    
    <meta name="theme-color" content="#000000">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/48/gold-bars.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/192/gold-bars.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- PREMIUM DARK THEME --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Segoe UI', sans-serif; background-color: #000; color: #fff; 
            margin: 0; display: flex; justify-content: center; min-height: 100vh; 
        }
        .app-container { width: 100%; max-width: 450px; padding: 15px; display: flex; flex-direction: column; }
        
        /* HEADER */
        .header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; 
            background: linear-gradient(145deg, #1a1a1a, #111); padding: 12px 15px; 
            border-radius: 15px; border: 1px solid #333; 
        }
        .logo-area h3 { 
            margin: 0; font-size: 18px; 
            background: linear-gradient(to right, #ffd700, #ffb900); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            text-transform: uppercase; letter-spacing: 1px; font-weight: 800; 
        }
        .icon-btn { background: none; border: none; font-size: 22px; cursor: pointer; }

        /* CARD */
        .card { background-color: #111; padding: 15px; border-radius: 20px; border: 1px solid #222; margin-bottom: 15px; }
        
        /* INPUTS */
        .main-input { 
            width: 100%; padding: 15px; margin-bottom: 15px; background: #000; 
            border: 2px solid #333; border-radius: 12px; font-size: 32px; 
            color: #ffd700; text-align: center; font-weight: bold; outline: none;
        }
        .main-input:focus { border-color: #ffd700; }

        /* TABS */
        .tab-box { display: flex; gap: 10px; margin-bottom: 20px; background: #1a1a1a; padding: 5px; border-radius: 30px; }
        .t-btn { 
            background: transparent; color: #888; border: none; padding: 12px; 
            border-radius: 25px; font-size: 13px; font-weight: bold; flex: 1; 
        }
        .t-btn.active { background: linear-gradient(90deg, #ffd700, #ff9800); color: #000; }

        /* GRID */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .small-input { 
            width: 100%; padding: 12px; background: #080808; border: 1px solid #333; 
            border-radius: 8px; color: #ccc; text-align: center; font-weight: 600; 
        }
        .weight-input { 
            width: 100%; padding: 15px; background: #252525; border: 1px solid #444; 
            border-radius: 10px; color: #fff; text-align: center; font-size: 24px; font-weight: bold; 
        }

        /* RESULT */
        .row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .lbl { font-size: 12px; color: #777; }
        .val { font-size: 14px; font-weight: bold; color: #fff; text-align: right; border:none; background:transparent; width:100px; }
        .total { font-size: 26px; font-weight: bold; color: #ffd700; text-align: right; border:none; background:transparent; width:180px; }
        
        .section-22 { border-left: 4px solid #ffd700; padding-left: 10px; margin-bottom: 15px; }
        .section-21 { border-left: 4px solid #2196f3; padding-left: 10px; margin-bottom: 15px; }
        .hidden { display: none; }

        /* BUTTONS */
        .btn-pdf { 
            width: 100%; padding: 16px; background: linear-gradient(90deg, #28a745, #218838); 
            color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 20px; 
        }
        .name-input { width: 100%; padding: 12px; margin-bottom: 10px; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; }

        /* MODAL */
        #settingsModal, #converterPage { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99; padding: 20px; }
        .close-btn { background: none; border: none; color: red; font-size: 24px; float: right; }
        .set-row { margin-bottom: 15px; }
        .set-row label { display: block; color: #888; margin-bottom: 5px; }
        
        /* PDF PRINT */
        #pdfContent { display: none; background: white; color: #000; width: 595px; padding: 40px; font-family: 'Times New Roman'; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .pdf-table th { border-bottom: 2px solid #000; padding: 5px; }
        .pdf-table td { border-bottom: 1px solid #ddd; padding: 8px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <button class="icon-btn" onclick="openPage('converterPage')">üßÆ</button>
        <div class="logo-area"><h3>GOLD APP</h3></div>
        <button class="icon-btn" onclick="openPage('settingsModal')">‚öôÔ∏è</button>
    </div>

    <div class="card">
        <label style="color:#666; font-size:12px; letter-spacing:1px;">SCREEN RATE</label>
        <input type="number" id="screenRate" class="main-input" placeholder="0.00" oninput="calc()">

        <div class="tab-box">
            <button class="t-btn active" onclick="setTab('22')" id="btn22">22K</button>
            <button class="t-btn" onclick="setTab('21')" id="btn21">21K</button>
            <button class="t-btn" onclick="setTab('both')" id="btnBoth">Both</button>
        </div>

        <div id="sec22" class="section-22">
            <div class="row">
                <span style="color:#ffd700; font-weight:bold;">22 Karat</span>
                <small style="color:#888;" id="p22Display">92.6%</small>
            </div>
            <div class="grid-2">
                <input type="number" id="mc22" class="small-input" placeholder="MC" oninput="calc()">
                <input type="number" id="dh22" class="small-input" placeholder="Dh" oninput="calc()">
                <input type="number" id="cr22" class="small-input" placeholder="CR" oninput="calc()">
                <input type="number" id="mg22" class="small-input" placeholder="MG" oninput="calc()">
            </div>
            <input type="number" id="w22" class="weight-input" placeholder="Weight (g)" oninput="calc()">
            <div class="row"><span class="lbl">Rate/Bhori</span> <input id="r22" class="val" readonly></div>
            <div class="row"><span class="lbl">Total Tk</span> <input id="t22" class="total" readonly></div>
        </div>

        <div id="sec21" class="section-21 hidden">
            <div class="row">
                <span style="color:#2196f3; font-weight:bold;">21 Karat</span>
                <small style="color:#888;" id="p21Display">88.5%</small>
            </div>
            <div class="grid-2">
                <input type="number" id="mc21" class="small-input" placeholder="MC" oninput="calc()">
                <input type="number" id="dh21" class="small-input" placeholder="Dh" oninput="calc()">
                <input type="number" id="cr21" class="small-input" placeholder="CR" oninput="calc()">
                <input type="number" id="mg21" class="small-input" placeholder="MG" oninput="calc()">
            </div>
            <input type="number" id="w21" class="weight-input" placeholder="Weight (g)" oninput="calc()">
            <div class="row"><span class="lbl">Rate/Bhori</span> <input id="r21" class="val" readonly></div>
            <div class="row"><span class="lbl">Total Tk</span> <input id="t21" class="total" style="color:#2196f3;" readonly></div>
        </div>

        <div style="background:#222; padding:15px; border-radius:10px; text-align:center; margin-top:10px;">
            <small style="color:#aaa;">GRAND TOTAL</small>
            <div id="grandTotal" style="font-size:32px; font-weight:bold; color:#fff;">0.00</div>
        </div>

        <div style="margin-top:20px;">
            <input id="cName" class="name-input" placeholder="Customer Name">
            <input id="authName" class="name-input" placeholder="Authorized By">
        </div>
        <button class="btn-pdf" onclick="genPDF()">DOWNLOAD INVOICE</button>
    </div>
</div>

<div id="settingsModal">
    <button class="close-btn" onclick="closePage('settingsModal')">‚úï</button>
    <h2 style="color:#ffd700;">Settings</h2>
    <div class="set-row"><label>22K Purity</label><input id="conf_p22" class="small-input" style="width:100%"></div>
    <div class="set-row"><label>21K Purity</label><input id="conf_p21" class="small-input" style="width:100%"></div>
    <button class="btn-pdf" onclick="saveConf()">SAVE</button>
</div>

<div id="converterPage">
    <button class="close-btn" onclick="closePage('converterPage')">‚úï</button>
    <h2 style="color:#ffd700;">Converter</h2>
    <input type="number" id="cv_g" class="main-input" placeholder="Gram" oninput="gToB()">
    <div style="text-align:center; font-size:24px;">‚áÖ</div>
    <input type="number" id="cv_b" class="main-input" placeholder="Bhori" oninput="bToG()">
    <div id="cv_res" style="text-align:center; font-size:20px; color:#ffd700; margin-top:20px;"></div>
</div>

<div id="pdfContent">
    <h1 style="text-align:center; border-bottom:2px solid #000;">INVOICE</h1>
    <p><strong>Customer:</strong> <span id="pCus"></span> <span style="float:right;"><strong>Date:</strong> <span id="pDate"></span></span></p>
    <table class="pdf-table">
        <thead><tr><th>Item</th><th style="text-align:right">Weight</th><th style="text-align:right">Rate/Bhori</th><th style="text-align:right">Total</th></tr></thead>
        <tbody id="pBody"></tbody>
    </table>
    <h3 style="text-align:right; margin-top:20px;">Total: <span id="pTotal"></span></h3>
    <div style="margin-top:60px; display:flex; justify-content:space-between;">
        <div style="border-top:1px solid #000; width:150px; text-align:center;">Signature</div>
        <div style="border-top:1px solid #000; width:150px; text-align:center;">Authorized By</div>
    </div>
</div>

<script>
    // --- 2. SERVICE WORKER CONNECTION (‡¶è‡¶ü‡¶ø ‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç ‡¶õ‡¶ø‡¶≤) ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
        .then(() => console.log('SW Ready!'))
        .catch((e) => console.log('SW Failed:', e));
    }

    let cfg = { p22: 0.926, p21: 0.885 };

    function init() {
        let s = localStorage.getItem('gold_cfg');
        if(s) cfg = JSON.parse(s);
        document.getElementById('conf_p22').value = cfg.p22;
        document.getElementById('conf_p21').value = cfg.p21;
        document.getElementById('p22Display').innerText = (cfg.p22*100).toFixed(1)+'%';
        document.getElementById('p21Display').innerText = (cfg.p21*100).toFixed(1)+'%';
    }

    function calc() {
        let s = parseFloat(document.getElementById('screenRate').value) || 0;
        
        let mc22 = p('mc22'), dh22 = p('dh22'), cr22 = p('cr22'), mg22 = p('mg22'), w22 = p('w22');
        let r22 = ((s * 3.674 / 31.1035 * cfg.p22) + mc22) * dh22 * 11.664 + cr22 + mg22;
        let t22 = w22 > 0 ? r22 * (w22 / 11.664) : 0;
        
        document.getElementById('r22').value = Math.round(r22).toLocaleString('en-BD');
        document.getElementById('t22').value = t22.toLocaleString('en-BD', {minimumFractionDigits:2});

        let mc21 = p('mc21'), dh21 = p('dh21'), cr21 = p('cr21'), mg21 = p('mg21'), w21 = p('w21');
        let r21 = ((s * 3.674 / 31.1035 * cfg.p21) + mc21) * dh21 * 11.664 + cr21 + mg21;
        let t21 = w21 > 0 ? r21 * (w21 / 11.664) : 0;

        document.getElementById('r21').value = Math.round(r21).toLocaleString('en-BD');
        document.getElementById('t21').value = t21.toLocaleString('en-BD', {minimumFractionDigits:2});

        document.getElementById('grandTotal').innerText = (t22 + t21).toLocaleString('en-BD', {minimumFractionDigits:2});
    }

    function p(id) { return parseFloat(document.getElementById(id).value) || 0; }

    function setTab(m) {
        document.getElementById('btn22').classList.remove('active');
        document.getElementById('btn21').classList.remove('active');
        document.getElementById('btnBoth').classList.remove('active');
        document.getElementById('sec22').classList.remove('hidden');
        document.getElementById('sec21').classList.remove('hidden');

        if(m=='22') { document.getElementById('btn22').classList.add('active'); document.getElementById('sec21').classList.add('hidden'); }
        else if(m=='21') { document.getElementById('btn21').classList.add('active'); document.getElementById('sec22').classList.add('hidden'); }
        else { document.getElementById('btnBoth').classList.add('active'); }
    }

    function openPage(id) { document.getElementById(id).style.display = 'block'; }
    function closePage(id) { document.getElementById(id).style.display = 'none'; }

    function saveConf() {
        cfg.p22 = parseFloat(document.getElementById('conf_p22').value);
        cfg.p21 = parseFloat(document.getElementById('conf_p21').value);
        localStorage.setItem('gold_cfg', JSON.stringify(cfg));
        location.reload();
    }

    function gToB() {
        let g = p('cv_g');
        if(!g) return;
        let b = g / 11.664;
        fmt(b);
    }
    function bToG() {
        let b = p('cv_b');
        if(!b) return;
        let g = b * 11.664;
        document.getElementById('cv_g').value = g.toFixed(3);
        fmt(b);
    }
    function fmt(b) {
        let v = Math.floor(b), rem = b-v, a = Math.floor(rem*16), r = ((rem*16)-a)*6;
        document.getElementById('cv_res').innerText = `${v} Vori ${a} Ana ${r.toFixed(1)} Ratti`;
    }

    function genPDF() {
        let d = new Date();
        document.getElementById('pDate').innerText = d.toLocaleDateString();
        document.getElementById('pCus').innerText = document.getElementById('cName').value;
        document.getElementById('pTotal').innerText = document.getElementById('grandTotal').innerText;
        
        let h = '';
        if(p('w22')>0) h+= `<tr><td>22K Gold</td><td style="text-align:right">${p('w22')}g</td><td style="text-align:right">${document.getElementById('r22').value}</td><td style="text-align:right">${document.getElementById('t22').value}</td></tr>`;
        if(p('w21')>0) h+= `<tr><td>21K Gold</td><td style="text-align:right">${p('w21')}g</td><td style="text-align:right">${document.getElementById('r21').value}</td><td style="text-align:right">${document.getElementById('t21').value}</td></tr>`;
        
        document.getElementById('pBody').innerHTML = h;
        
        let el = document.getElementById('pdfContent');
        el.style.display = 'block';
        html2pdf().set({margin:0.5, filename:'Invoice.pdf', image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'}}).from(el).save().then(()=> el.style.display='none');
    }

    window.onload = init;
</script>
</body>
</html>
