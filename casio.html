<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casio Pro</title>
    <link href="https://fonts.cdnfonts.com/css/digital-7-mono" rel="stylesheet">
    
    <style>
        /* --- CSS START --- */
        :root { --primary: #ff9f43; --secondary: #0abde3; --bg-color: #f4f7f6; --text-main: #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; 
            height: 100vh; /* Fallback */
            height: 100dvh; /* Mobile Full Height */
            width: 100%; 
            background: #000; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Top Bar (Compact) */
        .top-bar { 
            height: 40px; background: #111; display: flex; align-items: center; 
            padding: 0 10px; border-bottom: 1px solid #333; color: white; 
            justify-content: space-between; flex-shrink: 0;
        }
        .back-btn { text-decoration: none; color: white; font-size: 14px; font-weight: bold; background: #333; padding: 4px 10px; border-radius: 15px; }

        /* Screen Area (Takes ~22% of height) */
        .screen { 
            flex: 0 0 22%; 
            background: #000; padding: 5px 15px; 
            display: flex; flex-direction: column; 
            border-bottom: 1px solid #222;
        }
        .indicators { display: flex; justify-content: space-between; color: #555; height: 20px; font-size: 12px; }
        .step { font-family: monospace; color: var(--secondary); border: 1px solid #333; padding: 0px 4px; border-radius: 3px; }
        .op-display { text-align: right; color: var(--primary); font-size: 18px; height: 22px; font-family: monospace; }
        
        /* Main Display Text */
        .main-display { 
            flex: 1; display: flex; align-items: flex-end; justify-content: flex-end; 
            overflow: hidden;
        }
        .main-text { 
            font-family: 'Digital-7 Mono', monospace; color: #fff; 
            font-size: 50px; line-height: 1; word-break: break-all; text-align: right;
        }

        /* Controls (Compact) */
        .controls { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; 
            padding: 6px 8px; background: #f4f7f6; flex-shrink: 0; 
        }
        .c-btn { background: #fff; border: 1px solid #ddd; padding: 10px 0; border-radius: 8px; font-weight: bold; font-size: 12px; box-shadow: 0 2px 0 #ccc; color: #555; }
        
        /* Keypad (Fills Remaining Space Perfectly) */
        .keypad { 
            flex: 1; /* ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶¨ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ ‡¶®‡ßá‡¶¨‡ßá */
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(5, 1fr); /* ‡ß´‡¶ü‡¶ø ‡¶∏‡¶æ‡¶∞‡¶ø ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶≠‡¶æ‡¶ó‡ßá ‡¶≠‡¶æ‡¶ó ‡¶π‡¶¨‡ßá */
            gap: 6px; 
            padding: 0 8px 8px; /* Bottom padding reduced */
            background: #f4f7f6; 
            min-height: 0;
        }
        .k-btn { 
            width: 100%; height: 100%; /* ‡¶ó‡ßç‡¶∞‡¶ø‡¶° ‡¶∏‡ßá‡¶≤‡ßá‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã‡¶ü‡¶æ ‡¶®‡ßá‡¶¨‡ßá */
            border-radius: 10px; border: 1px solid #ddd; background: #fff; 
            font-size: 24px; font-weight: bold; color: #333; 
            box-shadow: 0 2px 0 #ccc; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
        }
        .k-btn:active { transform: translateY(2px); box-shadow: none; background: #eee; }
        .ac { color: #ff6b6b; } .op { color: var(--primary); } 
        .eq { background: var(--primary); color: #fff; border: none; box-shadow: 0 2px 0 #e67e22; }

        /* Drawer */
        .drawer { position: absolute; bottom: -100%; left: 0; width: 100%; height: 60%; background: #222; z-index: 100; transition: 0.3s; color: #fff; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; border-top: 2px solid #ff9f43; }
        .drawer.open { bottom: 0; }
        .d-head { padding: 10px 15px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .d-body { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .d-row { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid #333; 
            font-family: monospace; font-size: 14px; 
        }
        .d-exp { color: #aaa; font-size: 13px; }
        .d-res { color: #fff; font-size: 16px; font-weight: bold; }
    </style>
</head>
<body onload="init()">

    <div class="top-bar">
        <a href="index.html" class="back-btn">‚¨Ö Menu</a>
        <span>Casio Pro</span>
        <div style="width: 50px;"></div>
    </div>

    <div class="screen">
        <div class="indicators">
            <span class="step" id="step">00</span>
            <span style="color:var(--primary); font-weight:bold; display:none;" id="mode">REV</span>
        </div>
        <div class="op-display" id="opDisp"></div>
        <div class="main-display">
            <span class="main-text" id="mainDisp">0</span>
        </div>
    </div>

    <div class="controls">
        <button class="c-btn" style="color:#0abde3" onclick="prev()">‚óÄ PREV</button>
        <button class="c-btn" style="color:#0abde3" onclick="next()">NEXT ‚ñ∂</button>
        <button class="c-btn" onclick="toggleDrawer()">üìú List</button>
        <button class="c-btn" style="color:#ff9f43" onclick="correct()">CORR</button>
    </div>

    <div class="keypad">
        <button class="k-btn ac" onclick="AC()">AC</button>
        <button class="k-btn op" onclick="del()">‚å´</button>
        <button class="k-btn op" onclick="op('%')">%</button>
        <button class="k-btn op" onclick="op('/')">√∑</button>

        <button class="k-btn" onclick="num('7')">7</button>
        <button class="k-btn" onclick="num('8')">8</button>
        <button class="k-btn" onclick="num('9')">9</button>
        <button class="k-btn op" onclick="op('*')">√ó</button>

        <button class="k-btn" onclick="num('4')">4</button>
        <button class="k-btn" onclick="num('5')">5</button>
        <button class="k-btn" onclick="num('6')">6</button>
        <button class="k-btn op" onclick="op('-')">‚àí</button>

        <button class="k-btn" onclick="num('1')">1</button>
        <button class="k-btn" onclick="num('2')">2</button>
        <button class="k-btn" onclick="num('3')">3</button>
        <button class="k-btn op" onclick="op('+')">+</button>

        <button class="k-btn" onclick="num('00')">00</button>
        <button class="k-btn" onclick="num('0')">0</button>
        <button class="k-btn" onclick="num('.')">.</button>
        <button class="k-btn eq" onclick="eq()">=</button>
    </div>

    <div class="drawer" id="drawer">
        <div class="d-head">
            <span>Calculation History</span>
            <span onclick="toggleDrawer()" style="cursor:pointer; color:#ff6b6b;">‚úï Close</span>
        </div>
        <div class="d-body" id="list"></div>
    </div>

    <script>
        /* --- Logic Fixed --- */
        let tape = [], chain = [], input = "0";
        let idx = -1, edit = false, resShown = false;
        let isNewStep = false; 

        const ui = { main: document.getElementById('mainDisp'), op: document.getElementById('opDisp'), step: document.getElementById('step'), list: document.getElementById('list') };

        function init() {
            if(localStorage.getItem('casio_data')) {
                try { tape = JSON.parse(localStorage.getItem('casio_data')); } catch(e) { tape=[]; }
            }
            render(); renderList();
        }

        function num(n) {
            if(resShown) { AC(); input = n === "." ? "0." : n; render(); return; }
            if(isNewStep) { input = n === "." ? "0." : n; isNewStep = false; } 
            else {
                if(input.replace('.','').length >= 12) return;
                if(input === "0" && n !== ".") input = n;
                else if(n === "." && input.includes(".")) return;
                else input += n;
            }
            render();
        }

        function op(o) {
            if(edit) return;
            if(idx !== -1) { let val = chain[idx].v; chain = []; input = val; idx = -1; }
            if(isNewStep && chain.length > 0) { chain[chain.length-1].o = o; render(); return; }
            
            chain.push({v: input, o: o});
            try {
                let expr = chain.reduce((a,c) => a + c.v + (c.o.replace('x','*').replace('√∑','/')), "");
                if("+-*/%".includes(expr.slice(-1))) expr = expr.slice(0,-1);
                input = String(eval(expr)); 
            } catch(e) {}
            isNewStep = true; resShown = false; render();
        }

        function eq() {
            if(edit) { finishCorr(); return; }
            if(input === "" || isNewStep) return; 
            chain.push({v: input, o: '='});
            let expr = chain.reduce((a,c) => a + c.v + (c.o==='='?'':c.o.replace('x','*').replace('√∑','/')), "");
            try {
                let res = eval(expr);
                chain.push({v: String(res), o: 'ANS'});
                tape.push([...chain]); save();
                input = String(res); resShown = true; isNewStep = true; 
                render(); renderList();
            } catch(e) { input = "Error"; render(); }
        }

        function AC() { chain=[]; input="0"; idx=-1; edit=false; resShown=false; isNewStep=false; render(); }
        function del() { if(resShown || isNewStep) return; input = input.toString().slice(0,-1) || "0"; render(); }
        function prev() { if(tape.length && idx===-1) { chain=tape[tape.length-1]; idx=chain.length-1; } else if(idx>0) idx--; render(); }
        function next() { if(idx!==-1 && idx<chain.length-1) idx++; render(); }
        function correct() { if(idx!==-1 && chain[idx].o!=='ANS') { edit=true; input=chain[idx].v; isNewStep=false; render(); } }
        
        function finishCorr() {
            chain[idx].v = input;
            let newChain = chain.slice(0, chain.length-1);
            let expr = newChain.reduce((a,c) => a + c.v + (c.o==='='?'':c.o.replace('x','*').replace('√∑','/')), "");
            try {
                let res = eval(expr);
                newChain.push({v:String(res), o:'ANS'});
                chain = newChain; tape[tape.length-1] = chain; save();
                edit=false; input="0"; idx=-1; resShown=true; input=String(res);
                render(); renderList();
            } catch(e){}
        }

        function render() {
            let dV = input, dO = ""; let stepNum = 0;
            if(edit) { dV = input; dO = "EDIT"; document.getElementById('mode').style.display="block"; stepNum = idx + 1; } 
            else if(idx!==-1) { let item = chain[idx]; dV = item.v; dO = item.o==='ANS'?'=':item.o; document.getElementById('mode').style.display="block"; stepNum = idx + 1; } 
            else { document.getElementById('mode').style.display="none"; if(chain.length > 0 && !resShown) dO = chain[chain.length-1].o; stepNum = chain.length + (isNewStep ? 0 : 1); }
            
            ui.main.innerText = parseFloat(dV).toLocaleString(undefined, {maximumFractionDigits: 10});
            ui.op.innerText = dO.replace('*','√ó').replace('/','√∑');
            ui.step.innerText = String(stepNum).padStart(2,'0');
            resize();
        }

        function resize() {
            let s = 50; ui.main.style.fontSize = s+"px"; 
            while(ui.main.scrollWidth > ui.main.parentElement.clientWidth && s>30) { s-=5; ui.main.style.fontSize=s+"px"; }
        }

        function save() { localStorage.setItem('casio_data', JSON.stringify(tape)); }
        function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); }
        
        function renderList() {
            let html = "";
            tape.slice().reverse().forEach(t => {
                let expression = "";
                let result = "";
                t.forEach(item => {
                    if(item.o === 'ANS') {
                        result = item.v;
                    } else {
                        let sym = item.o.replace('x','√ó').replace('/','√∑');
                        if(sym === '=') sym = ''; 
                        expression += item.v + " " + sym + " ";
                    }
                });
                
                html += `
                <div class="d-row">
                    <span class="d-exp">${expression}=</span>
                    <span class="d-res">${parseFloat(result).toLocaleString()}</span>
                </div>`;
            });
            ui.list.innerHTML = html || "<div style='text-align:center; color:#555; margin-top:20px;'>No History</div>";
        }
    </script>
</body>
</html>
